{% extends '../base.html' %}

{% block title %}Chat Rooms - ChatHub{% endblock %}

{% block extra_css %}
<style>
    .chat-sidebar {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .room-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .room-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }
    
    .room-card:hover::before {
        left: 100%;
    }
    
    .room-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .room-card.active {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    .room-card.has-new-message {
        animation: newMessagePulse 2s ease-in-out;
    }
    
    @keyframes newMessagePulse {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }
    
    .unread-badge {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        animation: pulse-notification 2s infinite;
        transition: all 0.3s ease;
    }
    
    .unread-badge.updating {
        animation: bounceIn 0.6s ease-out;
    }
    
    @keyframes pulse-notification {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .online-indicator {
        position: relative;
    }
    
    .status-online { 
        background: #10b981; 
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        animation: pulse-online 2s infinite;
    }
    
    .status-away { 
        background: #f59e0b; 
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }
    
    .status-busy { 
        background: #ef4444; 
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }
    
    @keyframes pulse-online {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .typing-indicator {
        background: rgba(102, 126, 234, 0.2);
        border-radius: 15px;
        padding: 4px 8px;
        font-size: 11px;
        color: #667eea;
        animation: typingPulse 1.5s infinite;
        margin-top: 2px;
    }
    
    @keyframes typingPulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }
    
    .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .connection-status.connected {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .connection-status.disconnected {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .connection-status.connecting {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .real-time-stats {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
    }
    
    .stat-value {
        font-weight: 600;
        color: #10b981;
        transition: all 0.3s ease;
    }
    
    .stat-value.updating {
        transform: scale(1.2);
        color: #667eea;
    }
    
    .activity-stream {
        max-height: 300px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(-20px);
        animation: slideInActivity 0.5s ease-out forwards;
    }
    
    .activity-item.new {
        background: rgba(102, 126, 234, 0.1);
        border-left: 3px solid #667eea;
    }
    
    @keyframes slideInActivity {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
        border-radius: 8px;
        height: 80px;
        margin-bottom: 12px;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .notification-toast {
        position: fixed;
        top: 60px;
        right: 20px;
        background: rgba(16, 185, 129, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1001;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
    }
    
    .notification-toast.show {
        transform: translateX(0);
    }
    
    .notification-toast.error {
        background: rgba(239, 68, 68, 0.95);
    }
    
    .notification-toast.warning {
        background: rgba(245, 158, 11, 0.95);
    }
</style>
{% endblock %}

{% block content %}
<!-- Connection Status Indicator -->
<div id="connectionStatus" class="connection-status connecting">
    <i class="fas fa-wifi mr-1"></i>
    <span id="statusText">Connecting...</span>
</div>

<!-- Toast Notifications -->
<div id="toastContainer"></div>

<div class="min-h-screen bg-gray-900 flex">
    <!-- Enhanced Sidebar with Real-time Stats -->
    <div class="chat-sidebar w-80 flex-shrink-0 h-screen sticky top-0 overflow-hidden">
        <div class="p-6 border-b border-white/10">
            <h1 class="text-2xl font-bold text-white mb-4">
                Chat Rooms
                <span class="text-sm font-normal text-white/60 ml-2" id="roomCount">({{ rooms.count }})</span>
            </h1>
            
            <!-- Real-time Stats Panel -->
            <div class="real-time-stats mb-4">
                <h3 class="text-white text-sm font-semibold mb-2 flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    Live Stats
                </h3>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Online Users</span>
                    <span class="stat-value" id="onlineCount">{{ online_users|default:0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Active Rooms</span>
                    <span class="stat-value" id="activeRooms">{{ rooms.count }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Unread Messages</span>
                    <span class="stat-value" id="totalUnread">0</span>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="relative mb-4">
                <input type="text" 
                       class="w-full pl-10 pr-4 py-3 rounded-xl text-white placeholder-white/60 outline-none transition-all duration-300 bg-white/10 border border-white/20 focus:border-purple-500 focus:bg-white/15"
                       placeholder="Search rooms..."
                       id="roomSearch">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-white/60"></i>
            </div>
            
            <!-- Room Categories with Live Counts -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="category-filter active px-3 py-1 text-sm rounded-full bg-white/10 text-white border border-white/20 transition-all duration-300 hover:bg-white/20" data-type="all">
                    All <span id="allCount">({{ rooms.count }})</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="group">
                    Groups <span id="groupCount">(0)</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="private">
                    Private <span id="privateCount">(0)</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="forum">
                    Forums <span id="forumCount">(0)</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="event">
                    Events <span id="eventCount">(0)</span>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="p-6">
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
        </div>
        
        <!-- Room List Container -->
        <div class="flex-1 overflow-y-auto p-6" id="roomListContainer" style="display: none;">
            <div class="space-y-3" id="roomList">
                <!-- Rooms will be populated here via WebSocket -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12" style="display: none;">
                <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comment-slash text-white/60 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-white mb-2">No Chat Rooms</h3>
                <p class="text-white/60 text-sm mb-6">You haven't joined any chat rooms yet. Create or join one to start chatting!</p>
                <button class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300" onclick="openCreateRoomModal()">
                    <i class="fas fa-plus mr-2"></i>Create Room
                </button>
            </div>
        </div>
        
        <!-- Activity Stream -->
        <div class="border-t border-white/10 p-4">
            <h3 class="text-white text-sm font-semibold mb-3 flex items-center">
                <i class="fas fa-activity mr-2 text-green-400"></i>
                Recent Activity
            </h3>
            <div class="activity-stream" id="activityStream">
                <!-- Activity items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Welcome Screen -->
        <div class="flex-1 flex items-center justify-center p-8">
            <div class="text-center max-w-md">
                <div class="w-32 h-32 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-comment-dots text-white text-4xl"></i>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-4">Welcome to ChatHub</h2>
                <p class="text-white/70 text-lg mb-8">
                    Select a chat room from the sidebar to start messaging with your community.
                </p>
                
                <!-- Live Online Users Preview -->
                <div id="onlineUsersPreview" class="mb-8">
                    <h3 class="text-white font-semibold mb-4">Currently Online (<span id="onlineUsersCount">0</span>)</h3>
                    <div class="flex justify-center flex-wrap gap-2" id="onlineUsersList">
                        <!-- Online users will be populated here -->
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-xl hover-glow transition-all duration-300 font-semibold" onclick="openCreateRoomModal()">
                        <i class="fas fa-plus mr-2"></i>Create Room
                    </button>
                    <button class="px-6 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all duration-300 font-semibold border border-white/20" onclick="refreshRoomList()">
                        <i class="fas fa-sync-alt mr-2" id="refreshIcon"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class RealTimeRoomList {
        constructor() {
            this.socket = null;
            this.reconnectAttempts = 0;
            this.maxReconnectAttempts = 5;
            this.reconnectDelay = 1000;
            this.rooms = new Map();
            this.typingUsers = new Map();
            this.connectionStatus = 'disconnected';
            
            this.initializeWebSocket();
            this.setupEventListeners();
            this.startPeriodicTasks();
        }
        
        initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/room-list/`;
            
            this.updateConnectionStatus('connecting');
            
            try {
                this.socket = new WebSocket(wsUrl);
                this.socket.onopen = this.handleSocketOpen.bind(this);
                this.socket.onmessage = this.handleSocketMessage.bind(this);
                this.socket.onclose = this.handleSocketClose.bind(this);
                this.socket.onerror = this.handleSocketError.bind(this);
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                this.scheduleReconnect();
            }
        }
        
        handleSocketOpen(event) {
            console.log('WebSocket connected successfully');
            this.updateConnectionStatus('connected');
            this.reconnectAttempts = 0;
            
            // Request initial data
            this.sendMessage({
                type: 'request_room_data'
            });
            
            // Start sending periodic activity updates
            this.startActivityTracking();
        }
        
        handleSocketMessage(event) {
            try {
                const data = JSON.parse(event.data);
                this.handleWebSocketData(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        }
        
        handleSocketClose(event) {
            console.log('WebSocket disconnected:', event.code, event.reason);
            this.updateConnectionStatus('disconnected');
            
            if (!event.wasClean) {
                this.scheduleReconnect();
            }
        }
        
        handleSocketError(error) {
            console.error('WebSocket error:', error);
            this.updateConnectionStatus('disconnected');
        }
        
        scheduleReconnect() {
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
                
                this.showNotification(`Reconnecting in ${delay/1000}s... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'warning');
                
                setTimeout(() => {
                    this.initializeWebSocket();
                }, delay);
            } else {
                this.showNotification('Unable to connect. Please refresh the page.', 'error', 0);
            }
        }
        
        handleWebSocketData(data) {
            switch (data.type) {
                case 'room_list_update':
                    this.updateRoomList(data.rooms);
                    this.updateOnlineUsers(data.online_users);
                    this.updateRecentActivities(data.recent_activities);
                    break;
                    
                case 'new_message':
                    this.handleNewMessage(data);
                    break;
                    
                case 'room_member_update':
                    this.handleRoomMemberUpdate(data);
                    break;
                    
                case 'typing_update':
                    this.handleTypingUpdate(data);
                    break;
                    
                case 'user_status_change':
                    this.handleUserStatusChange(data);
                    break;
                    
                case 'online_users_update':
                    this.updateOnlineUsers(data.online_users);
                    break;
                    
                case 'activity_update':
                    this.updateRecentActivities(data.recent_activities);
                    break;
            }
        }
        
        updateRoomList(rooms) {
            const roomListContainer = document.getElementById('roomListContainer');
            const roomList = document.getElementById('roomList');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            
            // Hide loading state
            loadingState.style.display = 'none';
            roomListContainer.style.display = 'block';
            
            if (rooms.length === 0) {
                roomList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Store rooms data
            this.rooms.clear();
            rooms.forEach(room => this.rooms.set(room.id, room));
            
            // Update room cards
            this.renderRoomCards(rooms);
            
            // Update category counts
            this.updateCategoryCounts(rooms);
            
            // Update total unread count
            this.updateTotalUnreadCount(rooms);
            
            // Update room count
            document.getElementById('roomCount').textContent = `(${rooms.length})`;
        }
        
        renderRoomCards(rooms) {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';
            
            rooms.forEach((room, index) => {
                const roomCard = this.createRoomCard(room);
                roomCard.style.animationDelay = `${index * 50}ms`;
                roomList.appendChild(roomCard);
            });
        }
        
        createRoomCard(room) {
            const card = document.createElement('a');
            card.href = `/chat/room/${room.id}/`;
            card.className = 'room-card block p-4 rounded-xl relative';
            card.dataset.type = room.room_type;
            card.dataset.roomId = room.id;
            card.style.animation = 'slideInActivity 0.5s ease-out forwards';
            
            const isPrivate = room.is_private;
            const displayName = isPrivate && room.other_user ? 
                room.other_user.display_name : room.name;
            
            card.innerHTML = `
                <div class="flex items-center space-x-3">
                    <!-- Room Avatar -->
                    <div class="relative">
                        ${this.createRoomAvatar(room)}
                        ${this.createStatusIndicator(room)}
                    </div>
                    
                    <!-- Room Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <h3 class="font-semibold text-white truncate">${displayName}</h3>
                            <span class="room-type-badge type-${room.room_type} text-xs px-2 py-1 rounded-full">
                                ${room.room_type.charAt(0).toUpperCase() + room.room_type.slice(1)}
                            </span>
                        </div>
                        
                        <!-- Last message or room info -->
                        <div class="room-info">
                            ${this.createRoomInfo(room)}
                        </div>
                        
                        <!-- Typing indicator -->
                        <div class="typing-indicator-container" id="typing-${room.id}" style="display: none;">
                            <div class="typing-indicator">
                                <span class="typing-text">Someone is typing...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Unread Count & Time -->
                    <div class="text-right flex flex-col items-end">
                        ${this.createUnreadBadge(room)}
                        ${this.createTimestamp(room)}
                    </div>
                </div>
            `;
            
            // Add click handler
            card.addEventListener('click', (e) => this.handleRoomClick(e, room));
            
            return card;
        }
        
        createRoomAvatar(room) {
            if (room.is_private && room.other_user) {
                const avatarUrl = room.other_user.avatar_url || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(room.other_user.username)}&background=667eea&color=fff&size=48`;
                
                return `
                    <div class="w-12 h-12 rounded-full overflow-hidden">
                        <img src="${avatarUrl}" alt="${room.other_user.username}" class="w-full h-full object-cover">
                    </div>
                `;
            } else {
                const iconMap = {
                    group: 'fa-users',
                    forum: 'fa-comments',
                    event: 'fa-calendar',
                    private: 'fa-user'
                };
                
                const colorMap = {
                    group: 'from-yellow-500 to-orange-500',
                    forum: 'from-blue-500 to-indigo-500',
                    event: 'from-green-500 to-teal-500',
                    private: 'from-purple-500 to-blue-500'
                };
                
                return `
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r ${colorMap[room.room_type]} flex items-center justify-center text-white font-semibold">
                        <i class="fas ${iconMap[room.room_type]}"></i>
                    </div>
                `;
            }
        }
        
        createStatusIndicator(room) {
            if (room.is_private && room.other_user) {
                const statusClass = room.other_user.is_online ? 'status-online' : 'status-away';
                return `<div class="absolute -bottom-1 -right-1 w-3 h-3 ${statusClass} rounded-full border-2 border-gray-900"></div>`;
            } else if (room.online_members_count > 0) {
                return `<div class="absolute -bottom-1 -right-1 w-3 h-3 status-online rounded-full border-2 border-gray-900"></div>`;
            }
            return '';
        }
        
        createRoomInfo(room) {
            if (room.last_message) {
                const message = room.last_message;
                let content = '';
                
                if (message.message_type === 'file') {
                    content = `<i class="fas fa-file mr-1"></i>${message.sender} sent a file`;
                } else if (message.message_type === 'image') {
                    content = `<i class="fas fa-image mr-1"></i>${message.sender} sent an image`;
                } else {
                    content = `<span class="font-medium">${message.sender}:</span> ${message.content}`;
                }
                
                return `<div class="room-preview text-sm text-white/60 truncate">${content}</div>`;
            } else {
                if (room.is_private) {
                    return `<div class="member-count text-sm text-white/60">Private conversation</div>`;
                } else {
                    const onlineText = room.online_members_count > 0 ? 
                        ` • <span class="text-green-400">${room.online_members_count} online</span>` : '';
                    return `<div class="member-count text-sm text-white/60">
                        <i class="fas fa-users mr-1"></i>${room.member_count} members${onlineText}
                    </div>`;
                }
            }
        }
        
        createUnreadBadge(room) {
            if (room.unread_count > 0) {
                const count = room.unread_count > 99 ? '99+' : room.unread_count;
                return `<div class="unread-badge w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold mb-1" id="unread-${room.id}">${count}</div>`;
            } else if (room.has_unread) {
                return `<div class="w-2 h-2 bg-red-500 rounded-full mb-2 animate-pulse" id="unread-${room.id}"></div>`;
            }
            return `<div id="unread-${room.id}"></div>`;
        }
        
        createTimestamp(room) {
            if (room.last_message) {
                const date = new Date(room.last_message.created_at);
                const now = new Date();
                const diffHours = (now - date) / (1000 * 60 * 60);
                
                let timeText = '';
                if (diffHours < 1) {
                    timeText = 'Now';
                } else if (diffHours < 24) {
                    timeText = date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                } else if (diffHours < 48) {
                    timeText = 'Yesterday';
                } else {
                    timeText = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                }
                
                return `<div class="text-xs text-white/50">${timeText}</div>`;
            } else {
                const date = new Date(room.created_at);
                return `<div class="text-xs text-white/50">${date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</div>`;
            }
        }
        
        handleNewMessage(data) {
            const room = this.rooms.get(data.room_id);
            if (!room) return;
            
            // Update room data
            room.last_message = {
                content: data.message.content,
                sender: data.sender.username,
                created_at: data.timestamp,
                message_type: data.message.message_type || 'text'
            };
            room.unread_count = data.unread_count;
            room.has_unread = data.unread_count > 0;
            
            // Update room card
            this.updateSingleRoomCard(room);
            
            // Show notification if not in room
            if (!window.location.pathname.includes(`/chat/room/${data.room_id}/`)) {
                this.showNotification(
                    `New message from ${data.sender.username} in ${room.name}`,
                    'info',
                    5000
                );
                
                // Add visual feedback
                const roomCard = document.querySelector(`[data-room-id="${data.room_id}"]`);
                if (roomCard) {
                    roomCard.classList.add('has-new-message');
                    setTimeout(() => roomCard.classList.remove('has-new-message'), 2000);
                }
            }
            
            // Update total unread count
            this.updateTotalUnreadCount(Array.from(this.rooms.values()));
        }
        
        handleRoomMemberUpdate(data) {
            const room = this.rooms.get(data.room_id);
            if (!room) return;
            
            room.member_count = data.member_count;
            room.online_members_count = data.online_count;
            
            this.updateSingleRoomCard(room);
            
            // Show activity notification
            const actionText = data.action === 'joined' ? 'joined' : 'left';
            this.showNotification(`${data.user.username} ${actionText} ${room.name}`, 'info', 3000);
        }
        
        handleTypingUpdate(data) {
            const typingContainer = document.getElementById(`typing-${data.room_id}`);
            if (!typingContainer) return;
            
            if (data.is_typing) {
                const typingText = typingContainer.querySelector('.typing-text');
                typingText.textContent = `${data.user} is typing...`;
                typingContainer.style.display = 'block';
                
                // Auto-hide after 3 seconds
                clearTimeout(this.typingUsers.get(data.room_id));
                this.typingUsers.set(data.room_id, setTimeout(() => {
                    typingContainer.style.display = 'none';
                }, 3000));
            } else {
                typingContainer.style.display = 'none';
                clearTimeout(this.typingUsers.get(data.room_id));
            }
        }
        
        updateSingleRoomCard(room) {
            const roomCard = document.querySelector(`[data-room-id="${room.id}"]`);
            if (!roomCard) return;
            
            // Update room info
            const roomInfo = roomCard.querySelector('.room-info');
            roomInfo.innerHTML = this.createRoomInfo(room);
            
            // Update unread badge
            const unreadElement = document.getElementById(`unread-${room.id}`);
            if (unreadElement) {
                unreadElement.outerHTML = this.createUnreadBadge(room);
                
                // Add animation to new badge
                const newBadge = document.getElementById(`unread-${room.id}`);
                if (newBadge && newBadge.classList.contains('unread-badge')) {
                    newBadge.classList.add('updating');
                    setTimeout(() => newBadge.classList.remove('updating'), 600);
                }
            }
            
            // Update timestamp
            const timestamp = roomCard.querySelector('.text-xs.text-white\\/50');
            if (timestamp) {
                timestamp.outerHTML = this.createTimestamp(room);
            }
            
            // Update status indicator
            const statusIndicator = roomCard.querySelector('.status-online, .status-away');
            const avatarContainer = roomCard.querySelector('.relative');
            const existingIndicator = avatarContainer.querySelector('.absolute');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            avatarContainer.insertAdjacentHTML('beforeend', this.createStatusIndicator(room));
        }
        
        updateOnlineUsers(users) {
            const onlineCount = document.getElementById('onlineCount');
            const onlineUsersCount = document.getElementById('onlineUsersCount');
            const onlineUsersList = document.getElementById('onlineUsersList');
            
            // Animate counter update
            if (onlineCount) {
                onlineCount.classList.add('updating');
                onlineCount.textContent = users.length;
                setTimeout(() => onlineCount.classList.remove('updating'), 300);
            }
            
            if (onlineUsersCount) {
                onlineUsersCount.textContent = users.length;
            }
            
            if (onlineUsersList && users.length > 0) {
                onlineUsersList.innerHTML = users.slice(0, 8).map(user => `
                    <div class="relative" title="${user.display_name}">
                        <div class="w-12 h-12 rounded-full overflow-hidden">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=random&size=48" 
                                 alt="${user.username}" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></div>
                    </div>
                `).join('') + (users.length > 8 ? `
                    <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white/60">
                        <span class="text-sm">+${users.length - 8}</span>
                    </div>
                ` : '');
            }
        }
        
        updateRecentActivities(activities) {
            const activityStream = document.getElementById('activityStream');
            if (!activityStream) return;
            
            activityStream.innerHTML = activities.slice(0, 5).map((activity, index) => `
                <div class="activity-item" style="animation-delay: ${index * 100}ms;">
                    <div class="w-6 h-6 rounded-full overflow-hidden mr-2 flex-shrink-0">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(activity.user.username)}&background=random&size=24" 
                             alt="${activity.user.username}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-white/70 leading-tight">
                            <span class="font-medium text-white">${activity.user.display_name}</span>
                            sent a message in
                            <span class="text-purple-400">${activity.room.name}</span>
                        </p>
                        <p class="text-xs text-white/40">${this.formatRelativeTime(activity.timestamp)}</p>
                    </div>
                </div>
            `).join('');
        }
        
        updateCategoryCounts(rooms) {
            const counts = {
                all: rooms.length,
                group: rooms.filter(r => r.room_type === 'group').length,
                private: rooms.filter(r => r.room_type === 'private').length,
                forum: rooms.filter(r => r.room_type === 'forum').length,
                event: rooms.filter(r => r.room_type === 'event').length
            };
            
            Object.entries(counts).forEach(([type, count]) => {
                const element = document.getElementById(`${type}Count`);
                if (element) {
                    element.textContent = `(${count})`;
                }
            });
        }
        
        updateTotalUnreadCount(rooms) {
            const totalUnread = rooms.reduce((sum, room) => sum + (room.unread_count || 0), 0);
            const totalUnreadElement = document.getElementById('totalUnread');
            
            if (totalUnreadElement) {
                totalUnreadElement.classList.add('updating');
                totalUnreadElement.textContent = totalUnread;
                setTimeout(() => totalUnreadElement.classList.remove('updating'), 300);
            }
        }
        
        handleRoomClick(event, room) {
            // Mark room as read
            this.sendMessage({
                type: 'mark_room_read',
                room_id: room.id
            });
            
            // Update unread count immediately for better UX
            const unreadElement = document.getElementById(`unread-${room.id}`);
            if (unreadElement) {
                unreadElement.style.opacity = '0';
                unreadElement.style.transform = 'scale(0)';
                setTimeout(() => {
                    unreadElement.innerHTML = '';
                }, 300);
            }
        }
        
        updateConnectionStatus(status) {
            this.connectionStatus = status;
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusElement.className = `connection-status ${status}`;
            
            const statusConfig = {
                connected: { icon: 'fa-wifi', text: 'Connected' },
                connecting: { icon: 'fa-spinner fa-spin', text: 'Connecting...' },
                disconnected: { icon: 'fa-wifi-slash', text: 'Disconnected' }
            };
            
            const config = statusConfig[status];
            statusElement.innerHTML = `<i class="fas ${config.icon} mr-1"></i><span>${config.text}</span>`;
            
            // Auto-hide connected status after 3 seconds
            if (status === 'connected') {
                setTimeout(() => {
                    statusElement.style.opacity = '0.7';
                }, 3000);
            }
        }
        
        showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button class="ml-2 text-white/80 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto-remove
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        sendMessage(data) {
            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.send(JSON.stringify(data));
            }
        }
        
        setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('roomSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.filterRooms(e.target.value.toLowerCase());
                }, 300);
            });
            
            // Category filters
            document.querySelectorAll('.category-filter').forEach(filter => {
                filter.addEventListener('click', (e) => {
                    this.handleCategoryFilter(e.target);
                });
            });
            
            // Refresh button
            window.refreshRoomList = () => {
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.classList.add('fa-spin');
                
                this.sendMessage({ type: 'request_room_data' });
                
                setTimeout(() => {
                    refreshIcon.classList.remove('fa-spin');
                }, 1000);
            };
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
                
                if (e.key === 'Escape' && document.activeElement === searchInput) {
                    searchInput.value = '';
                    searchInput.blur();
                    this.filterRooms('');
                }
            });
            
            // Page visibility change handling
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // User returned to page, send activity update
                    this.sendMessage({ type: 'user_activity' });
                }
            });
            
            // Before unload cleanup
            window.addEventListener('beforeunload', () => {
                if (this.socket) {
                    this.socket.close();
                }
            });
        }
        
        startPeriodicTasks() {
            // Send periodic activity updates
            setInterval(() => {
                this.sendMessage({ type: 'user_activity' });
            }, 30000); // Every 30 seconds
            
            // Update relative timestamps
            setInterval(() => {
                this.updateAllTimestamps();
            }, 60000); // Every minute
        }
        
        startActivityTracking() {
            // Track user activity
            let activityTimer;
            
            const trackActivity = () => {
                clearTimeout(activityTimer);
                activityTimer = setTimeout(() => {
                    this.sendMessage({ type: 'user_activity' });
                }, 1000);
            };
            
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, trackActivity, { passive: true });
            });
        }
        
        filterRooms(searchTerm) {
            const roomCards = document.querySelectorAll('.room-card');
            let visibleCount = 0;
            
            roomCards.forEach(card => {
                const roomName = card.querySelector('h3').textContent.toLowerCase();
                const roomInfo = card.querySelector('.room-preview, .member-count');
                const roomDescription = roomInfo ? roomInfo.textContent.toLowerCase() : '';
                
                const matches = roomName.includes(searchTerm) || roomDescription.includes(searchTerm);
                
                if (matches) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                    card.style.transform = 'translateX(0)';
                    visibleCount++;
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        if (card.style.opacity === '0') {
                            card.style.display = 'none';
                        }
                    }, 300);
                }
            });
            
            this.updateNoResultsMessage(visibleCount, searchTerm);
        }
        
        handleCategoryFilter(filterButton) {
            // Update active filter
            document.querySelectorAll('.category-filter').forEach(f => {
                f.classList.remove('active', 'bg-white/10', 'text-white', 'border-white/20');
                f.classList.add('text-white/60');
            });
            
            filterButton.classList.add('active', 'bg-white/10', 'text-white', 'border-white/20');
            filterButton.classList.remove('text-white/60');
            
            const selectedType = filterButton.dataset.type;
            const roomCards = document.querySelectorAll('.room-card');
            
            roomCards.forEach((card, index) => {
                const roomType = card.dataset.type;
                
                setTimeout(() => {
                    if (selectedType === 'all' || roomType === selectedType) {
                        card.style.display = 'block';
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 50);
                    } else {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            if (card.style.opacity === '0') {
                                card.style.display = 'none';
                            }
                        }, 300);
                    }
                }, index * 50);
            });
        }
        
        updateNoResultsMessage(visibleCount, searchTerm) {
            let noResultsMsg = document.getElementById('noResultsMessage');
            
            if (visibleCount === 0 && searchTerm.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'text-center py-12';
                    noResultsMsg.innerHTML = `
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-search text-white/60 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-white mb-2">No rooms found</h3>
                        <p class="text-white/60 text-sm mb-4">No rooms match "${searchTerm}". Try different keywords or create a new room.</p>
                        <button class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300" onclick="openCreateRoomModal()">
                            <i class="fas fa-plus mr-2"></i>Create "${searchTerm}" Room
                        </button>
                    `;
                    document.getElementById('roomList').appendChild(noResultsMsg);
                } else {
                    const description = noResultsMsg.querySelector('p');
                    const button = noResultsMsg.querySelector('button');
                    description.textContent = `No rooms match "${searchTerm}". Try different keywords or create a new room.`;
                    button.innerHTML = `<i class="fas fa-plus mr-2"></i>Create "${searchTerm}" Room`;
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        updateAllTimestamps() {
            const rooms = Array.from(this.rooms.values());
            rooms.forEach(room => {
                const roomCard = document.querySelector(`[data-room-id="${room.id}"]`);
                if (roomCard) {
                    const timestamp = roomCard.querySelector('.text-xs.text-white\\/50:last-child');
                    if (timestamp) {
                        const timeHtml = this.createTimestamp(room);
                        timestamp.outerHTML = timeHtml;
                    }
                }
            });
        }
        
        formatRelativeTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Public methods
        reconnect() {
            if (this.socket) {
                this.socket.close();
            }
            this.reconnectAttempts = 0;
            this.initializeWebSocket();
        }
        
        getConnectionStatus() {
            return this.connectionStatus;
        }
        
        getRoomCount() {
            return this.rooms.size;
        }
        
        getTotalUnreadCount() {
            return Array.from(this.rooms.values()).reduce((sum, room) => sum + (room.unread_count || 0), 0);
        }
    }
    
    // Additional utility functions
    window.openCreateRoomModal = function() {
        // Create modal implementation
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
        modal.id = 'createRoomModal';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-white/10 transform transition-all duration-300 scale-95 opacity-0">
                <h3 class="text-xl font-bold text-white mb-4">Create New Room</h3>
                <form id="createRoomForm">
                    <div class="mb-4">
                        <label class="block text-white/80 text-sm font-medium mb-2">Room Name</label>
                        <input type="text" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:border-purple-500" placeholder="Enter room name" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-white/80 text-sm font-medium mb-2">Room Type</label>
                        <select class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-purple-500">
                            <option value="group">Group Chat</option>
                            <option value="forum">Forum Discussion</option>
                            <option value="event">Event Chat</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-white/80 text-sm font-medium mb-2">Description (Optional)</label>
                        <textarea class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:border-purple-500 h-20" placeholder="Describe your room"></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors" onclick="closeCreateRoomModal()">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300">Create Room</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Animate in
        setTimeout(() => {
            const modalContent = modal.querySelector('.bg-gray-800');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        // Focus first input
        setTimeout(() => modal.querySelector('input').focus(), 100);
        
        // Handle form submission
        modal.querySelector('#createRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            closeCreateRoomModal();
            realTimeRoomList.showNotification('Room creation feature coming soon!', 'info');
        });
        
        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCreateRoomModal();
            }
        });
    };
    
    window.closeCreateRoomModal = function() {
        const modal = document.getElementById('createRoomModal');
        if (modal) {
            const modalContent = modal.querySelector('.bg-gray-800');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => modal.remove(), 300);
        }
    };
    
    // Initialize the real-time room list when DOM is loaded
    let realTimeRoomList;
    
    document.addEventListener('DOMContentLoaded', function() {
        realTimeRoomList = new RealTimeRoomList();
        
        // Make it globally accessible for debugging
        window.realTimeRoomList = realTimeRoomList;
        
        // Add some helpful console commands for debugging
        console.log('Real-time room list initialized!');
        console.log('Available commands:');
        console.log('- realTimeRoomList.reconnect() - Force reconnect WebSocket');
        console.log('- realTimeRoomList.getConnectionStatus() - Get connection status');
        console.log('- realTimeRoomList.getRoomCount() - Get room count');
        console.log('- realTimeRoomList.getTotalUnreadCount() - Get total unread count');
    });
    
    // Handle page visibility changes for better performance
    document.addEventListener('visibilitychange', function() {
        if (realTimeRoomList) {
            if (document.hidden) {
                console.log('Page hidden - reducing WebSocket activity');
            } else {
                console.log('Page visible - resuming normal WebSocket activity');
                // Request fresh data when user returns
                realTimeRoomList.sendMessage({ type: 'request_room_data' });
            }
        }
    });
    
    // Service Worker for offline functionality
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('ServiceWorker registered'))
                .catch(error => console.log('ServiceWorker registration failed'));
        });
    }
</script>

<!-- Add some helpful CSS for better room type badges -->
<style>
    .room-type-badge.type-group {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
    }
    
    .room-type-badge.type-private {
        background: rgba(139, 92, 246, 0.2);
        color: #c4b5fd;
    }
    
    .room-type-badge.type-forum {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
    }
    
    .room-type-badge.type-event {
        background: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
    }
    
    /* Enhanced loading states */
    .room-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .room-card:hover {
        transform: translateY(-2px) scale(1.01);
    }
    
    /* Better scrollbar for activity stream */
    .activity-stream::-webkit-scrollbar {
        width: 4px;
    }
    
    .activity-stream::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 2px;
    }
    
    .activity-stream::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.5);
        border-radius: 2px;
    }
    
    .activity-stream::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.7);
    }
    
    /* Improved hover effects */
    .stat-value:hover {
        transform: scale(1.1);
        color: #667eea !important;
    }
    
    /* Better focus states */
    .category-filter:focus {
        outline: 2px solid rgba(102, 126, 234, 0.5);
        outline-offset: 2px;
    }
    
    #roomSearch:focus {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
</style>
{% endblock %}