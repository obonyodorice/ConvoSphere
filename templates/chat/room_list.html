{% extends '../base.html' %}

{% block title %}Chat Rooms - ChatHub{% endblock %}

{% block extra_css %}
<style>
    .chat-sidebar {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .room-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .room-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }
    
    .room-card:hover::before {
        left: 100%;
    }
    
    .room-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .room-card.active {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.5);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    .room-card.has-new-message {
        animation: newMessagePulse 2s ease-in-out;
    }
    
    @keyframes newMessagePulse {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }
    
    .unread-badge {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        animation: pulse-notification 2s infinite;
        transition: all 0.3s ease;
    }
    
    .unread-badge.updating {
        animation: bounceIn 0.6s ease-out;
    }
    
    @keyframes pulse-notification {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .online-indicator {
        position: relative;
    }
    
    .status-online { 
        background: #10b981; 
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        animation: pulse-online 2s infinite;
    }
    
    .status-away { 
        background: #f59e0b; 
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }
    
    .status-busy { 
        background: #ef4444; 
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }
    
    @keyframes pulse-online {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .typing-indicator {
        background: rgba(102, 126, 234, 0.2);
        border-radius: 15px;
        padding: 4px 8px;
        font-size: 11px;
        color: #667eea;
        animation: typingPulse 1.5s infinite;
        margin-top: 2px;
    }
    
    @keyframes typingPulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }
    
    .connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .connection-status.connected {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .connection-status.disconnected {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .connection-status.connecting {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .real-time-stats {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
    }
    
    .stat-value {
        font-weight: 600;
        color: #10b981;
        transition: all 0.3s ease;
    }
    
    .stat-value.updating {
        transform: scale(1.2);
        color: #667eea;
    }
    
    .activity-stream {
        max-height: 300px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(-20px);
        animation: slideInActivity 0.5s ease-out forwards;
    }
    
    .activity-item.new {
        background: rgba(102, 126, 234, 0.1);
        border-left: 3px solid #667eea;
    }
    
    @keyframes slideInActivity {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
        border-radius: 8px;
        height: 80px;
        margin-bottom: 12px;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    .notification-toast {
        position: fixed;
        top: 60px;
        right: 20px;
        background: rgba(16, 185, 129, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1001;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
    }
    
    .notification-toast.show {
        transform: translateX(0);
    }
    
    .notification-toast.error {
        background: rgba(239, 68, 68, 0.95);
    }
    
    .notification-toast.warning {
        background: rgba(245, 158, 11, 0.95);
    }

    /* Create room modal styles */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    }
    
    .modal-content {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideInUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .room-type-badge.type-group {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
    }
    
    .room-type-badge.type-private {
        background: rgba(139, 92, 246, 0.2);
        color: #c4b5fd;
    }
    
    .room-type-badge.type-forum {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
    }
    
    .room-type-badge.type-event {
        background: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
    }
    
    .form-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 12px;
        color: white;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.5);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
</style>
{% endblock %}

{% block content %}
<!-- Connection Status Indicator -->
<div id="connectionStatus" class="connection-status connecting">
    <i class="fas fa-wifi mr-1"></i>
    <span id="statusText">Connecting...</span>
</div>

<!-- Toast Notifications -->
<div id="toastContainer"></div>

<!-- Create Room Modal -->
<div id="createRoomModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
    <div class="modal-content rounded-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-xl font-bold text-white mb-4">Create New Room</h3>
        <form id="createRoomForm">
            <div class="mb-4">
                <label class="block text-white/80 text-sm font-medium mb-2">Room Name</label>
                <input type="text" name="name" class="form-input w-full" placeholder="Enter room name" required maxlength="100">
            </div>
            <div class="mb-4">
                <label class="block text-white/80 text-sm font-medium mb-2">Room Type</label>
                <select name="room_type" class="form-input w-full">
                    <option value="group">Group Chat</option>
                    <option value="forum">Forum Discussion</option>
                    <option value="event">Event Chat</option>
                    <option value="private">Private Chat</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-white/80 text-sm font-medium mb-2">Description (Optional)</label>
                <textarea name="description" class="form-input w-full h-20" placeholder="Describe your room" maxlength="500"></textarea>
            </div>
            <div class="flex space-x-3">
                <button type="button" class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors" onclick="closeCreateRoomModal()">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300">
                    <i class="fas fa-plus mr-2"></i>Create Room
                </button>
            </div>
        </form>
    </div>
</div>

<div class="min-h-screen bg-gray-900 flex">
    <!-- Enhanced Sidebar with Real-time Stats -->
    <div class="chat-sidebar w-80 flex-shrink-0 h-screen sticky top-0 overflow-hidden">
        <div class="p-6 border-b border-white/10">
            <h1 class="text-2xl font-bold text-white mb-4">
                Chat Rooms
                <span class="text-sm font-normal text-white/60 ml-2" id="roomCount">({{ rooms.count }})</span>
            </h1>
            
            <!-- Real-time Stats Panel -->
            <div class="real-time-stats mb-4">
                <h3 class="text-white text-sm font-semibold mb-2 flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    Live Stats
                </h3>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Online Users</span>
                    <span class="stat-value" id="onlineCount">{{ online_users|length|default:0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Active Rooms</span>
                    <span class="stat-value" id="activeRooms">{{ rooms.count }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-white/60 text-sm">Unread Messages</span>
                    <span class="stat-value" id="totalUnread">{{ total_unread|default:0 }}</span>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="relative mb-4">
                <input type="text" 
                       class="w-full pl-10 pr-4 py-3 rounded-xl text-white placeholder-white/60 outline-none transition-all duration-300 bg-white/10 border border-white/20 focus:border-purple-500 focus:bg-white/15"
                       placeholder="Search rooms..."
                       id="roomSearch">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-white/60"></i>
            </div>
            
            <!-- Room Categories with Live Counts -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="category-filter active px-3 py-1 text-sm rounded-full bg-white/10 text-white border border-white/20 transition-all duration-300 hover:bg-white/20" data-type="all">
                    All <span id="allCount">({{ enhanced_rooms|length }})</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="group">
                    Groups <span id="groupCount">({{ room_type_counts.group }})</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="private">
                    Private <span id="privateCount">({{ room_type_counts.private }})</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="forum">
                    Forums <span id="forumCount">({{ room_type_counts.forum }})</span>
                </button>
                <button class="category-filter px-3 py-1 text-sm rounded-full text-white/60 hover:text-white hover:bg-white/10 transition-all duration-300" data-type="event">
                    Events <span id="eventCount">({{ room_type_counts.event }})</span>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="p-6 hidden">
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
        </div>
        
        <!-- Room List Container -->
        <div class="flex-1 overflow-y-auto p-6" id="roomListContainer">
            <div class="space-y-3" id="roomList">
                <!-- Populate with enhanced rooms data -->
                {% for room_data in enhanced_rooms %}
                    <a href="/chat/room/{{ room_data.id }}/" 
                       class="room-card block p-4 rounded-xl relative" 
                       data-type="{{ room_data.room_type }}" 
                       data-room-id="{{ room_data.id }}">
                        
                        <div class="flex items-center space-x-3">
                            <!-- Room Avatar -->
                            <div class="relative">
                                {% if room_data.is_private and room_data.other_user %}
                                    <div class="w-12 h-12 rounded-full overflow-hidden">
                                        <img src="https://ui-avatars.com/api/?name={{ room_data.other_user.username }}&background=667eea&color=fff&size=48" 
                                             alt="{{ room_data.other_user.username }}" class="w-full h-full object-cover">
                                    </div>
                                    {% if room_data.other_user.is_online %}
                                        <div class="absolute -bottom-1 -right-1 w-3 h-3 status-online rounded-full border-2 border-gray-900"></div>
                                    {% else %}
                                        <div class="absolute -bottom-1 -right-1 w-3 h-3 status-away rounded-full border-2 border-gray-900"></div>
                                    {% endif %}
                                {% else %}
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-r 
                                        {% if room_data.room_type == 'group' %}from-yellow-500 to-orange-500
                                        {% elif room_data.room_type == 'forum' %}from-blue-500 to-indigo-500
                                        {% elif room_data.room_type == 'event' %}from-green-500 to-teal-500
                                        {% else %}from-purple-500 to-blue-500{% endif %} 
                                        flex items-center justify-center text-white font-semibold">
                                        <i class="fas 
                                            {% if room_data.room_type == 'group' %}fa-users
                                            {% elif room_data.room_type == 'forum' %}fa-comments
                                            {% elif room_data.room_type == 'event' %}fa-calendar
                                            {% else %}fa-user{% endif %}"></i>
                                    </div>
                                    {% if room_data.online_members_count > 0 %}
                                        <div class="absolute -bottom-1 -right-1 w-3 h-3 status-online rounded-full border-2 border-gray-900"></div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <!-- Room Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h3 class="font-semibold text-white truncate">
                                        {% if room_data.is_private and room_data.other_user %}
                                            {{ room_data.other_user.display_name }}
                                        {% else %}
                                            {{ room_data.name }}
                                        {% endif %}
                                    </h3>
                                    <span class="room-type-badge type-{{ room_data.room_type }} text-xs px-2 py-1 rounded-full">
                                        {{ room_data.room_type|capfirst }}
                                    </span>
                                </div>
                                
                                <!-- Last message or room info -->
                                <div class="room-info">
                                    {% if room_data.last_message %}
                                        <div class="room-preview text-sm text-white/60 truncate">
                                            {% if room_data.last_message.message_type == 'file' %}
                                                <i class="fas fa-file mr-1"></i>{{ room_data.last_message.sender }} sent a file
                                            {% elif room_data.last_message.message_type == 'image' %}
                                                <i class="fas fa-image mr-1"></i>{{ room_data.last_message.sender }} sent an image
                                            {% else %}
                                                <span class="font-medium">{{ room_data.last_message.sender }}:</span> {{ room_data.last_message.content }}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        {% if room_data.is_private %}
                                            <div class="member-count text-sm text-white/60">Private conversation</div>
                                        {% else %}
                                            <div class="member-count text-sm text-white/60">
                                                <i class="fas fa-users mr-1"></i>{{ room_data.member_count }} members
                                                {% if room_data.online_members_count > 0 %}
                                                    • <span class="text-green-400">{{ room_data.online_members_count }} online</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                
                                <!-- Typing indicator -->
                                <div class="typing-indicator-container" id="typing-{{ room_data.id }}" style="display: none;">
                                    <div class="typing-indicator">
                                        <span class="typing-text">Someone is typing...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Unread Count & Time -->
                            <div class="text-right flex flex-col items-end">
                                {% if room_data.unread_count > 0 %}
                                    <div class="unread-badge w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold mb-1" id="unread-{{ room_data.id }}">
                                        {% if room_data.unread_count > 99 %}99+{% else %}{{ room_data.unread_count }}{% endif %}
                                    </div>
                                {% elif room_data.has_unread %}
                                    <div class="w-2 h-2 bg-red-500 rounded-full mb-2 animate-pulse" id="unread-{{ room_data.id }}"></div>
                                {% else %}
                                    <div id="unread-{{ room_data.id }}"></div>
                                {% endif %}
                                
                                {% if room_data.last_message %}
                                    <div class="text-xs text-white/50">
                                        {% now "c" as current_time %}
                                        {% if room_data.last_message.created_at|timeuntil:current_time < "1 hour" %}
                                            Now
                                        {% else %}
                                            {{ room_data.last_message.created_at|date:"H:i" }}
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="text-xs text-white/50">{{ room_data.created_at|date:"M j" }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12">
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-comment-slash text-white/60 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-white mb-2">No Chat Rooms</h3>
                        <p class="text-white/60 text-sm mb-6">You haven't joined any chat rooms yet. Create or join one to start chatting!</p>
                        <button class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300" onclick="openCreateRoomModal()">
                            <i class="fas fa-plus mr-2"></i>Create Room
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Activity Stream -->
        <div class="border-t border-white/10 p-4">
            <h3 class="text-white text-sm font-semibold mb-3 flex items-center">
                <i class="fas fa-activity mr-2 text-green-400"></i>
                Recent Activity
            </h3>
            <div class="activity-stream" id="activityStream">
                {% for activity in recent_activities|slice:":5" %}
                    <div class="activity-item" style="animation-delay: {% widthratio forloop.counter0 1 100 %}ms;">
                        <div class="w-6 h-6 rounded-full overflow-hidden mr-2 flex-shrink-0">
                            <img src="https://ui-avatars.com/api/?name={{ activity.user.username }}&background=random&size=24" 
                                 alt="{{ activity.user.username }}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-white/70 leading-tight">
                                <span class="font-medium text-white">{{ activity.user.display_name }}</span>
                                {% if activity.event_type == 'message_sent' %}sent a message in{% elif activity.event_type == 'user_joined' %}joined{% elif activity.event_type == 'room_created' %}created{% endif %}
                                <span class="text-purple-400">{{ activity.room.name }}</span>
                            </p>
                            <p class="text-xs text-white/40">{{ activity.timestamp|timesince }} ago</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Welcome Screen -->
        <div class="flex-1 flex items-center justify-center p-8">
            <div class="text-center max-w-md">
                <div class="w-32 h-32 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-comment-dots text-white text-4xl"></i>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-4">Welcome to ChatHub</h2>
                <p class="text-white/70 text-lg mb-8">
                    Select a chat room from the sidebar to start messaging with your community.
                </p>
                
                <!-- Live Online Users Preview -->
                <div id="onlineUsersPreview" class="mb-8">
                    <h3 class="text-white font-semibold mb-4">Currently Online (<span id="onlineUsersCount">{{ online_users|length }}</span>)</h3>
                    <div class="flex justify-center flex-wrap gap-2" id="onlineUsersList">
                        {% for user in online_users|slice:":8" %}
                            <div class="relative" title="{{ user.display_name }}">
                                <div class="w-12 h-12 rounded-full overflow-hidden">
                                    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&size=48" 
                                         alt="{{ user.username }}" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></div>
                            </div>
                        {% endfor %}
                        {% if online_users|length > 8 %}
                            <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white/60">
                                <span class="text-sm">+{{ online_users|length|add:"-8" }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-xl hover-glow transition-all duration-300 font-semibold" onclick="openCreateRoomModal()">
                        <i class="fas fa-plus mr-2"></i>Create Room
                    </button>
                    <button class="px-6 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all duration-300 font-semibold border border-white/20" onclick="refreshRoomList()">
                        <i class="fas fa-sync-alt mr-2" id="refreshIcon"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class RealTimeRoomList {
        constructor() {
            this.socket = null;
            this.reconnectAttempts = 0;
            this.maxReconnectAttempts = 5;
            this.reconnectDelay = 1000;
            this.rooms = new Map();
            this.typingUsers = new Map();
            this.connectionStatus = 'disconnected';
            
            this.initializeWebSocket();
            this.setupEventListeners();
            this.startPeriodicTasks();
        }
        
        initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/room-list/`;
            
            this.updateConnectionStatus('connecting');
            
            try {
                this.socket = new WebSocket(wsUrl);
                this.socket.onopen = this.handleSocketOpen.bind(this);
                this.socket.onmessage = this.handleSocketMessage.bind(this);
                this.socket.onclose = this.handleSocketClose.bind(this);
                this.socket.onerror = this.handleSocketError.bind(this);
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                this.scheduleReconnect();
            }
        }
        
        handleSocketOpen(event) {
            console.log('Room list WebSocket connected');
            this.updateConnectionStatus('connected');
            this.reconnectAttempts = 0;
            
            // Request initial data
            this.sendMessage({ type: 'request_room_data' });
        }
        
        handleSocketMessage(event) {
            try {
                const data = JSON.parse(event.data);
                this.handleWebSocketData(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        }
        
        handleSocketClose(event) {
            console.log('Room list WebSocket disconnected:', event.code, event.reason);
            this.updateConnectionStatus('disconnected');
            
            if (!event.wasClean && this.reconnectAttempts < this.maxReconnectAttempts) {
                this.scheduleReconnect();
            }
        }
        
        handleSocketError(error) {
            console.error('Room list WebSocket error:', error);
            this.updateConnectionStatus('disconnected');
        }
        
        scheduleReconnect() {
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
                
                this.showNotification(`Reconnecting in ${delay/1000}s... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'warning');
                
                setTimeout(() => {
                    this.initializeWebSocket();
                }, delay);
            } else {
                this.showNotification('Unable to connect. Please refresh the page.', 'error', 0);
            }
        }
        
        handleWebSocketData(data) {
            switch (data.type) {
                case 'room_list_update':
                    this.updateRoomList(data.rooms);
                    this.updateOnlineUsers(data.online_users);
                    this.updateRecentActivities(data.recent_activities);
                    break;
                    
                case 'new_message':
                    this.handleNewMessage(data);
                    break;
                    
                case 'room_member_update':
                    this.handleRoomMemberUpdate(data);
                    break;
                    
                case 'room_created':
                    this.handleRoomCreated(data);
                    break;
                    
                case 'read_status_update':
                    this.handleReadStatusUpdate(data);
                    break;
                    
                case 'online_users_update':
                    this.updateOnlineUsers(data.online_users);
                    break;
                    
                case 'activity_update':
                    this.updateRecentActivities(data.recent_activities);
                    break;
                    
                case 'error':
                    this.showNotification(data.message, 'error');
                    break;
            }
        }
        
        updateRoomList(rooms) {
            // Store rooms data
            this.rooms.clear();
            rooms.forEach(room => this.rooms.set(room.id, room));
            
            // Update room cards
            this.renderRoomCards(rooms);
            
            // Update category counts
            this.updateCategoryCounts(rooms);
            
            // Update total unread count
            this.updateTotalUnreadCount(rooms);
            
            // Update room count
            document.getElementById('roomCount').textContent = `(${rooms.length})`;
        }
        
        renderRoomCards(rooms) {
            const roomList = document.getElementById('roomList');
            const emptyState = document.getElementById('emptyState');
            
            if (rooms.length === 0) {
                roomList.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            roomList.innerHTML = '';
            
            rooms.forEach((room, index) => {
                const roomCard = this.createRoomCard(room);
                roomCard.style.animationDelay = `${index * 50}ms`;
                roomList.appendChild(roomCard);
            });
        }
        
        createRoomCard(room) {
            const card = document.createElement('a');
            card.href = `/chat/room/${room.id}/`;
            card.className = 'room-card block p-4 rounded-xl relative';
            card.dataset.type = room.room_type;
            card.dataset.roomId = room.id;
            card.style.animation = 'slideInActivity 0.5s ease-out forwards';
            
            const displayName = room.is_private && room.other_user ? 
                room.other_user.display_name : room.name;
            
            card.innerHTML = this.generateRoomCardHTML(room, displayName);
            
            // Add click handler for read marking
            card.addEventListener('click', (e) => this.handleRoomClick(e, room));
            
            return card;
        }
        
        generateRoomCardHTML(room, displayName) {
            return `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        ${this.createRoomAvatar(room)}
                        ${this.createStatusIndicator(room)}
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <h3 class="font-semibold text-white truncate">${displayName}</h3>
                            <span class="room-type-badge type-${room.room_type} text-xs px-2 py-1 rounded-full">
                                ${room.room_type.charAt(0).toUpperCase() + room.room_type.slice(1)}
                            </span>
                        </div>
                        
                        <div class="room-info">
                            ${this.createRoomInfo(room)}
                        </div>
                        
                        <div class="typing-indicator-container" id="typing-${room.id}" style="display: none;">
                            <div class="typing-indicator">
                                <span class="typing-text">Someone is typing...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right flex flex-col items-end">
                        ${this.createUnreadBadge(room)}
                        ${this.createTimestamp(room)}
                    </div>
                </div>
            `;
        }
        
        createRoomAvatar(room) {
            if (room.is_private && room.other_user) {
                const avatarUrl = room.other_user.avatar_url || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(room.other_user.username)}&background=667eea&color=fff&size=48`;
                
                return `
                    <div class="w-12 h-12 rounded-full overflow-hidden">
                        <img src="${avatarUrl}" alt="${room.other_user.username}" class="w-full h-full object-cover">
                    </div>
                `;
            } else {
                const iconMap = {
                    group: 'fa-users',
                    forum: 'fa-comments',
                    event: 'fa-calendar',
                    private: 'fa-user'
                };
                
                const colorMap = {
                    group: 'from-yellow-500 to-orange-500',
                    forum: 'from-blue-500 to-indigo-500',
                    event: 'from-green-500 to-teal-500',
                    private: 'from-purple-500 to-blue-500'
                };
                
                return `
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r ${colorMap[room.room_type]} flex items-center justify-center text-white font-semibold">
                        <i class="fas ${iconMap[room.room_type]}"></i>
                    </div>
                `;
            }
        }
        
        createStatusIndicator(room) {
            if (room.is_private && room.other_user) {
                const statusClass = room.other_user.is_online ? 'status-online' : 'status-away';
                return `<div class="absolute -bottom-1 -right-1 w-3 h-3 ${statusClass} rounded-full border-2 border-gray-900"></div>`;
            } else if (room.online_members_count > 0) {
                return `<div class="absolute -bottom-1 -right-1 w-3 h-3 status-online rounded-full border-2 border-gray-900"></div>`;
            }
            return '';
        }
        
        createRoomInfo(room) {
            if (room.last_message) {
                const message = room.last_message;
                let content = '';
                
                if (message.message_type === 'file') {
                    content = `<i class="fas fa-file mr-1"></i>${message.sender} sent a file`;
                } else if (message.message_type === 'image') {
                    content = `<i class="fas fa-image mr-1"></i>${message.sender} sent an image`;
                } else {
                    content = `<span class="font-medium">${message.sender}:</span> ${this.escapeHtml(message.content)}`;
                }
                
                return `<div class="room-preview text-sm text-white/60 truncate">${content}</div>`;
            } else {
                if (room.is_private) {
                    return `<div class="member-count text-sm text-white/60">Private conversation</div>`;
                } else {
                    const onlineText = room.online_members_count > 0 ? 
                        ` • <span class="text-green-400">${room.online_members_count} online</span>` : '';
                    return `<div class="member-count text-sm text-white/60">
                        <i class="fas fa-users mr-1"></i>${room.member_count} members${onlineText}
                    </div>`;
                }
            }
        }
        
        createUnreadBadge(room) {
            if (room.unread_count > 0) {
                const count = room.unread_count > 99 ? '99+' : room.unread_count;
                return `<div class="unread-badge w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold mb-1" id="unread-${room.id}">${count}</div>`;
            } else if (room.has_unread) {
                return `<div class="w-2 h-2 bg-red-500 rounded-full mb-2 animate-pulse" id="unread-${room.id}"></div>`;
            }
            return `<div id="unread-${room.id}"></div>`;
        }
        
        createTimestamp(room) {
            if (room.last_message) {
                const date = new Date(room.last_message.created_at);
                const now = new Date();
                const diffHours = (now - date) / (1000 * 60 * 60);
                
                let timeText = '';
                if (diffHours < 1) {
                    timeText = 'Now';
                } else if (diffHours < 24) {
                    timeText = date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                } else if (diffHours < 48) {
                    timeText = 'Yesterday';
                } else {
                    timeText = date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                }
                
                return `<div class="text-xs text-white/50">${timeText}</div>`;
            } else {
                const date = new Date(room.created_at);
                return `<div class="text-xs text-white/50">${date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</div>`;
            }
        }
        
        handleNewMessage(data) {
            const room = this.rooms.get(data.room_id);
            if (room) {
                // Update room data
                room.last_message = data.message;
                room.unread_count = data.unread_count;
                room.has_unread = data.unread_count > 0;
                
                // Update room card
                this.updateSingleRoomCard(room);
                
                // Show notification if not in current room
                if (!window.location.pathname.includes(`/chat/room/${data.room_id}/`)) {
                    this.showNotification(
                        `New message from ${data.sender.username}`,
                        'info',
                        5000
                    );
                    
                    // Add visual feedback
                    const roomCard = document.querySelector(`[data-room-id="${data.room_id}"]`);
                    if (roomCard) {
                        roomCard.classList.add('has-new-message');
                        setTimeout(() => roomCard.classList.remove('has-new-message'), 2000);
                    }
                }
            }
            
            // Update total unread count
            this.updateTotalUnreadCount(Array.from(this.rooms.values()));
        }
        
        handleRoomMemberUpdate(data) {
            const room = this.rooms.get(data.room_id);
            if (room) {
                room.member_count = data.member_count;
                room.online_members_count = data.online_count;
                this.updateSingleRoomCard(room);
                
                // Show activity notification
                const actionText = data.action === 'joined' ? 'joined' : 'left';
                this.showNotification(`${data.user.username} ${actionText} ${room.name}`, 'info', 3000);
            }
        }
        
        handleRoomCreated(data) {
            // Add new room to the list
            this.rooms.set(data.room.id, data.room);
            
            // Re-render room list
            this.renderRoomCards(Array.from(this.rooms.values()));
            
            // Show notification
            this.showNotification(`Room "${data.room.name}" created by ${data.creator.username}`, 'info', 5000);
        }
        
        handleReadStatusUpdate(data) {
            const room = this.rooms.get(data.room_id);
            if (room) {
                room.unread_count = data.unread_count;
                room.has_unread = data.unread_count > 0;
                this.updateSingleRoomCard(room);
            }
        }
        
        updateSingleRoomCard(room) {
            const roomCard = document.querySelector(`[data-room-id="${room.id}"]`);
            if (!roomCard) return;
            
            // Update the entire card content
            const displayName = room.is_private && room.other_user ? 
                room.other_user.display_name : room.name;
            
            roomCard.innerHTML = this.generateRoomCardHTML(room, displayName);
        }
        
        updateOnlineUsers(users) {
            const onlineCount = document.getElementById('onlineCount');
            const onlineUsersCount = document.getElementById('onlineUsersCount');
            const onlineUsersList = document.getElementById('onlineUsersList');
            
            // Animate counter update
            if (onlineCount) {
                onlineCount.classList.add('updating');
                onlineCount.textContent = users.length;
                setTimeout(() => onlineCount.classList.remove('updating'), 300);
            }
            
            if (onlineUsersCount) {
                onlineUsersCount.textContent = users.length;
            }
            
            if (onlineUsersList && users.length > 0) {
                onlineUsersList.innerHTML = users.slice(0, 8).map(user => `
                    <div class="relative" title="${this.escapeHtml(user.display_name)}">
                        <div class="w-12 h-12 rounded-full overflow-hidden">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=random&size=48" 
                                 alt="${this.escapeHtml(user.username)}" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></div>
                    </div>
                `).join('') + (users.length > 8 ? `
                    <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center text-white/60">
                        <span class="text-sm">+${users.length - 8}</span>
                    </div>
                ` : '');
            }
        }
        
        updateRecentActivities(activities) {
            const activityStream = document.getElementById('activityStream');
            if (!activityStream) return;
            
            activityStream.innerHTML = activities.slice(0, 5).map((activity, index) => `
                <div class="activity-item" style="animation-delay: ${index * 100}ms;">
                    <div class="w-6 h-6 rounded-full overflow-hidden mr-2 flex-shrink-0">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(activity.user.username)}&background=random&size=24" 
                             alt="${this.escapeHtml(activity.user.username)}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-white/70 leading-tight">
                            <span class="font-medium text-white">${this.escapeHtml(activity.user.display_name)}</span>
                            ${this.getActivityText(activity.event_type)}
                            <span class="text-purple-400">${this.escapeHtml(activity.room.name)}</span>
                        </p>
                        <p class="text-xs text-white/40">${this.formatRelativeTime(activity.timestamp)}</p>
                    </div>
                </div>
            `).join('');
        }
        
        getActivityText(eventType) {
            switch(eventType) {
                case 'message_sent': return 'sent a message in';
                case 'user_joined': return 'joined';
                case 'user_left': return 'left';
                case 'room_created': return 'created';
                default: return 'updated';
            }
        }
        
        updateCategoryCounts(rooms) {
            const counts = {
                all: rooms.length,
                group: rooms.filter(r => r.room_type === 'group').length,
                private: rooms.filter(r => r.room_type === 'private').length,
                forum: rooms.filter(r => r.room_type === 'forum').length,
                event: rooms.filter(r => r.room_type === 'event').length
            };
            
            Object.entries(counts).forEach(([type, count]) => {
                const element = document.getElementById(`${type}Count`);
                if (element) {
                    element.textContent = `(${count})`;
                }
            });
        }
        
        updateTotalUnreadCount(rooms) {
            const totalUnread = rooms.reduce((sum, room) => sum + (room.unread_count || 0), 0);
            const totalUnreadElement = document.getElementById('totalUnread');
            
            if (totalUnreadElement) {
                totalUnreadElement.classList.add('updating');
                totalUnreadElement.textContent = totalUnread;
                setTimeout(() => totalUnreadElement.classList.remove('updating'), 300);
            }
        }
        
        handleRoomClick(event, room) {
            // Mark room as read when clicking
            this.sendMessage({
                type: 'mark_room_read',
                room_id: room.id
            });
        }
        
        updateConnectionStatus(status) {
            this.connectionStatus = status;
            const statusElement = document.getElementById('connectionStatus');
            
            if (!statusElement) return;
            
            statusElement.className = `connection-status ${status}`;
            
            const statusConfig = {
                connected: { icon: 'fa-wifi', text: 'Connected' },
                connecting: { icon: 'fa-spinner fa-spin', text: 'Connecting...' },
                disconnected: { icon: 'fa-wifi-slash', text: 'Disconnected' }
            };
            
            const config = statusConfig[status];
            statusElement.innerHTML = `<i class="fas ${config.icon} mr-1"></i><span>${config.text}</span>`;
            
            // Auto-hide connected status after 3 seconds
            if (status === 'connected') {
                setTimeout(() => {
                    statusElement.style.opacity = '0.7';
                }, 3000);
            }
        }
        
        showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${this.escapeHtml(message)}</span>
                    <button class="ml-2 text-white/80 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto-remove
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        sendMessage(data) {
            if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.send(JSON.stringify(data));
            }
        }
        
        setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('roomSearch');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.filterRooms(e.target.value.toLowerCase());
                    }, 300);
                });
            }
            
            // Category filters
            document.querySelectorAll('.category-filter').forEach(filter => {
                filter.addEventListener('click', (e) => {
                    this.handleCategoryFilter(e.target);
                });
            });
            
            // Create room form
            const createForm = document.getElementById('createRoomForm');
            if (createForm) {
                createForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCreateRoom(e);
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                if (e.key === 'Escape') {
                    if (document.activeElement === searchInput) {
                        searchInput.value = '';
                        searchInput.blur();
                        this.filterRooms('');
                    }
                    closeCreateRoomModal();
                }
            });
        }
        
        handleCreateRoom(event) {
            const formData = new FormData(event.target);
            const roomData = {
                type: 'create_room',
                name: formData.get('name').trim(),
                room_type: formData.get('room_type'),
                description: formData.get('description').trim()
            };
            
            // Validation
            if (!roomData.name) {
                this.showNotification('Room name is required', 'error');
                return;
            }
            
            if (roomData.name.length > 100) {
                this.showNotification('Room name too long (max 100 characters)', 'error');
                return;
            }
            
            // Send via WebSocket
            this.sendMessage(roomData);
            
            // Close modal
            closeCreateRoomModal();
            
            // Show creating message
            this.showNotification('Creating room...', 'info', 2000);
        }
        
        filterRooms(searchTerm) {
            const roomCards = document.querySelectorAll('.room-card');
            let visibleCount = 0;
            
            roomCards.forEach(card => {
                const roomName = card.querySelector('h3').textContent.toLowerCase();
                const roomInfo = card.querySelector('.room-preview, .member-count');
                const roomDescription = roomInfo ? roomInfo.textContent.toLowerCase() : '';
                
                const matches = roomName.includes(searchTerm) || roomDescription.includes(searchTerm);
                
                if (matches) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                    card.style.transform = 'translateX(0)';
                    visibleCount++;
                } else {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        if (card.style.opacity === '0') {
                            card.style.display = 'none';
                        }
                    }, 300);
                }
            });
            
            this.updateNoResultsMessage(visibleCount, searchTerm);
        }
        
        handleCategoryFilter(filterButton) {
            // Update active filter
            document.querySelectorAll('.category-filter').forEach(f => {
                f.classList.remove('active', 'bg-white/10', 'text-white', 'border-white/20');
                f.classList.add('text-white/60');
            });
            
            filterButton.classList.add('active', 'bg-white/10', 'text-white', 'border-white/20');
            filterButton.classList.remove('text-white/60');
            
            const selectedType = filterButton.dataset.type;
            const roomCards = document.querySelectorAll('.room-card');
            
            roomCards.forEach((card, index) => {
                const roomType = card.dataset.type;
                
                setTimeout(() => {
                    if (selectedType === 'all' || roomType === selectedType) {
                        card.style.display = 'block';
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 50);
                    } else {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            if (card.style.opacity === '0') {
                                card.style.display = 'none';
                            }
                        }, 300);
                    }
                }, index * 50);
            });
        }
        
        updateNoResultsMessage(visibleCount, searchTerm) {
            let noResultsMsg = document.getElementById('noResultsMessage');
            
            if (visibleCount === 0 && searchTerm.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'text-center py-12';
                    noResultsMsg.innerHTML = `
                        <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-search text-white/60 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-white mb-2">No rooms found</h3>
                        <p class="text-white/60 text-sm mb-4">No rooms match "${this.escapeHtml(searchTerm)}". Try different keywords or create a new room.</p>
                        <button class="px-4 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover-glow transition-all duration-300" onclick="openCreateRoomModal()">
                            <i class="fas fa-plus mr-2"></i>Create "${this.escapeHtml(searchTerm)}" Room
                        </button>
                    `;
                    document.getElementById('roomList').appendChild(noResultsMsg);
                } else {
                    const description = noResultsMsg.querySelector('p');
                    const button = noResultsMsg.querySelector('button');
                    description.textContent = `No rooms match "${searchTerm}". Try different keywords or create a new room.`;
                    button.innerHTML = `<i class="fas fa-plus mr-2"></i>Create "${this.escapeHtml(searchTerm)}" Room`;
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        startPeriodicTasks() {
            // Send periodic activity updates
            setInterval(() => {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.sendMessage({ type: 'user_activity' });
                }
            }, 30000); // Every 30 seconds
        }
        
        formatRelativeTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Public methods
        reconnect() {
            if (this.socket) {
                this.socket.close();
            }
            this.reconnectAttempts = 0;
            this.initializeWebSocket();
        }
        
        getConnectionStatus() {
            return this.connectionStatus;
        }
        
        getRoomCount() {
            return this.rooms.size;
        }
        
        getTotalUnreadCount() {
            return Array.from(this.rooms.values()).reduce((sum, room) => sum + (room.unread_count || 0), 0);
        }
    }
    
    // Modal functions
    function openCreateRoomModal() {
        const modal = document.getElementById('createRoomModal');
        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('input[name="name"]').focus(), 100);
        }
    }
    
    function closeCreateRoomModal() {
        const modal = document.getElementById('createRoomModal');
        if (modal) {
            modal.classList.add('hidden');
            // Reset form
            const form = modal.querySelector('#createRoomForm');
            if (form) form.reset();
        }
    }
    
    // Refresh function
    function refreshRoomList() {
        const refreshIcon = document.getElementById('refreshIcon');
        if (refreshIcon) {
            refreshIcon.classList.add('fa-spin');
        }
        
        if (window.realTimeRoomList) {
            window.realTimeRoomList.sendMessage({ type: 'request_room_data' });
        }
        
        setTimeout(() => {
            if (refreshIcon) {
                refreshIcon.classList.remove('fa-spin');
            }
        }, 1000);
    }
    
    // Initialize when DOM is ready
    let realTimeRoomList;
    
    document.addEventListener('DOMContentLoaded', function() {
        realTimeRoomList = new RealTimeRoomList();
        window.realTimeRoomList = realTimeRoomList;
        
        // Make functions global
        window.openCreateRoomModal = openCreateRoomModal;
        window.closeCreateRoomModal = closeCreateRoomModal;
        window.refreshRoomList = refreshRoomList;
        
        console.log('Real-time room list initialized!');
    });
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (realTimeRoomList && !document.hidden) {
            // Request fresh data when user returns
            realTimeRoomList.sendMessage({ type: 'request_room_data' });
        }
    });
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('createRoomModal');
        if (modal && e.target === modal) {
            closeCreateRoomModal();
        }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (realTimeRoomList && realTimeRoomList.socket) {
            realTimeRoomList.socket.close();
        }
    });
</script>
{% endblock %}